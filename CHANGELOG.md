# 変更履歴

このドキュメントでは、Plane SNS ECサイトの修正内容と改善点をまとめています。

## [v2.0.0] - 2025-10-22

### 🔒 セキュリティの大幅強化

#### 管理者認証の改善
- **変更前**: 管理者のユーザー名とパスワードがソースコードに平文でハードコード
- **変更後**: 
  - bcryptによるパスワードハッシュ化を実装
  - 環境変数ベースの認証情報管理に移行
  - デフォルトパスワード「ChangeMe123!」を設定（本番環境では変更必須）
  - データベースベースの認証への移行パスを用意

**影響**: 管理者アカウントへの不正アクセスリスクを大幅に削減

#### トランザクション処理の実装
- **変更前**: 注文処理が複数の個別クエリで実行され、データ不整合のリスクあり
- **変更後**: 
  - PostgreSQLのストアドプロシージャ`create_order_transaction`を実装
  - ACID特性を保証するトランザクション処理
  - エラー時の自動ロールバック機能

**影響**: 注文処理の信頼性が向上し、データの整合性を保証

#### レート制限の実装
- **変更前**: APIエンドポイントにレート制限がなく、DDoS攻撃に脆弱
- **変更後**: 
  - Upstash Redisを使用したレート制限機能を実装
  - メモリベースのフォールバック機能も提供
  - エンドポイントタイプ別の制限設定（一般API、認証API、決済API）

**影響**: DDoS攻撃やブルートフォース攻撃からの保護

### 📝 コード品質の向上

#### 型定義の統一
- **追加**: `types/api.ts` - フロントエンドとバックエンドで共有される型定義
- **内容**: 
  - APIレスポンス型
  - 商品、注文、ユーザー関連の型
  - エラー型とバリデーションエラー型

**影響**: 型安全性の向上、開発効率の改善

#### 定数管理の一元化
- **追加**: `lib/constants.ts` - アプリケーション全体で使用する定数
- **内容**: 
  - デフォルト値（画像URL、評価など）
  - 制限値（カート数量、注文金額など）
  - レート制限設定
  - エラーメッセージと成功メッセージ

**影響**: マジックナンバーの削減、保守性の向上

#### バリデーションの強化
- **追加**: `lib/validation/schemas.ts` - Zodスキーマによる入力検証
- **内容**: 
  - 商品、注文、チャージ、検索のバリデーションスキーマ
  - 管理者ログインのバリデーション
  - ページネーションのバリデーション

**影響**: 入力エラーの早期検出、セキュリティの向上

### 🗄️ データベースの改善

#### ストアドプロシージャの追加
- **追加**: `sql/create_order_transaction.sql`
- **機能**: 
  - 残高確認
  - 在庫確認と予約
  - 注文作成
  - 購入済みアカウント更新
  - 残高更新
  - 取引履歴記録
  - エラー時の自動ロールバック

**影響**: データの整合性保証、パフォーマンス向上

### 📚 ドキュメントの充実

#### 新規ドキュメント
1. **SETUP_GUIDE.md** - 詳細なセットアップ手順
   - 環境構築
   - Supabaseプロジェクトのセットアップ
   - 環境変数の設定
   - データベースのセットアップ
   - トラブルシューティング

2. **DEPLOYMENT_GUIDE.md** - デプロイメント手順
   - Vercel、Netlify、AWS EC2へのデプロイ
   - 環境変数の設定
   - カスタムドメインの設定
   - SSL証明書の設定
   - パフォーマンス最適化

3. **SECURITY_GUIDE.md** - セキュリティガイド
   - 認証とアクセス制御
   - データ保護
   - 入力バリデーション
   - レート制限
   - セキュリティヘッダー
   - インシデント対応

4. **README_SALES.md** - 販売用README
   - 製品の特徴
   - 価格プラン
   - デモサイト
   - サポート情報

5. **CHANGELOG.md** - 変更履歴（このファイル）

#### 改善されたドキュメント
- **.env.example** - 環境変数のサンプルを改善、詳細なコメントを追加

### 🔧 設定ファイルの改善

#### 環境変数の整理
- **変更前**: 一部の機密情報がソースコードに含まれていた
- **変更後**: 
  - すべての機密情報を環境変数に移行
  - `.env.example`に詳細な説明を追加
  - 必須項目とオプション項目を明確化

### 📦 依存関係の追加

新たに以下のパッケージを追加しました:

- `bcryptjs` - パスワードのハッシュ化
- `@types/bcryptjs` - bcryptjsの型定義
- `zod` - スキーマバリデーション
- `@upstash/ratelimit` - レート制限
- `@upstash/redis` - Redis クライアント

### 🐛 バグ修正

#### 注文処理のN+1クエリ問題
- **変更前**: ループ内で個別にデータベースクエリを実行
- **変更後**: ストアドプロシージャによる一括処理

#### 検索APIのSQLインジェクションリスク
- **変更前**: 文字列結合によるクエリ構築
- **変更後**: パラメータ化されたクエリビルダーの使用

### ⚠️ 破壊的変更

#### 管理者認証
- **変更内容**: 管理者認証のロジックが変更されました
- **移行方法**: 
  1. 環境変数`ADMIN_PASSWORD_HASH`と`EDITOR_PASSWORD_HASH`を設定
  2. パスワードハッシュを生成: `node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('your-password', 10));"`
  3. 開発環境ではデフォルトパスワード「ChangeMe123!」が使用可能

#### 注文API
- **変更内容**: 注文処理がストアドプロシージャを使用するように変更
- **移行方法**: 
  1. `sql/create_order_transaction.sql`をSupabaseで実行
  2. 既存の注文処理コードを更新

### 📈 パフォーマンス改善

- ストアドプロシージャによるデータベースクエリの最適化
- N+1クエリ問題の解消
- レート制限によるサーバー負荷の軽減

### 🔐 セキュリティ改善のまとめ

| 項目 | 変更前 | 変更後 | リスクレベル |
|------|--------|--------|-------------|
| 管理者認証 | 平文パスワード | bcryptハッシュ化 | 致命的 → 低 |
| トランザクション | なし | あり | 高 → 低 |
| レート制限 | なし | あり | 高 → 低 |
| 入力バリデーション | 部分的 | 完全 | 中 → 低 |
| SQLインジェクション | リスクあり | 対策済み | 中 → 低 |

### 📋 今後の改善予定

以下の機能は将来のバージョンで実装予定です:

- [ ] E2Eテストの拡充
- [ ] 管理者情報のデータベース管理
- [ ] 二要素認証の実装
- [ ] より詳細なログ機能
- [ ] パフォーマンス監視ダッシュボード
- [ ] 自動バックアップ機能
- [ ] 多言語対応

### 🙏 謝辞

このバージョンの改善は、セキュリティレビューとコード品質分析に基づいて実施されました。

---

## [v1.0.0] - 2024-11-01

### 初回リリース

- Next.js 15ベースのECサイト
- Supabase統合
- 商品管理機能
- 注文処理機能
- 管理画面
- PayPay統合（オプション）

