# SQL スクリプト

このディレクトリには、データベースのセットアップと管理に使用するSQLスクリプトが含まれています。

## 📋 ファイル一覧

### 🚀 セットアップ用（初回セットアップ時に実行）

1. **`master_schema.sql`** ⭐ **最重要**
   - データベースの完全なスキーマを作成
   - テーブル、インデックス、RLSポリシー、トリガーを含む
   - **初回セットアップ時は必ずこれを実行してください**

2. **`create_order_transaction.sql`** ⭐ **必須**
   - 注文処理用のストアドプロシージャを作成
   - トランザクション処理によりデータ整合性を保証
   - `master_schema.sql`の後に実行してください

3. **`02_create_analytics_functions.sql`** 📊 **オプション**
   - 売上分析用の関数を作成
   - 管理ダッシュボードで使用

### 🔧 メンテナンス用

4. **`01_truncate_data.sql`** ⚠️ **注意**
   - トランザクションデータ（注文、チャージ履歴など）を削除
   - ユーザー情報と商品マスターは保持
   - **実行前にバックアップを取ってください**

5. **`reset_database.sql`** ⚠️ **危険**
   - データベースを完全にリセット
   - すべてのデータが削除されます
   - **開発環境でのみ使用してください**

6. **`fix_permissions.sql`** 🔐 **トラブルシューティング用**
   - サービスロールの権限を修正
   - 権限エラーが発生した場合に実行

## 📝 実行順序

### 初回セットアップ

```sql
-- 1. マスタースキーマの作成
-- master_schema.sql を実行

-- 2. トランザクション関数の作成
-- create_order_transaction.sql を実行

-- 3. 分析関数の作成（オプション）
-- 02_create_analytics_functions.sql を実行
```

### データベースのリセット

```sql
-- 1. データベースを完全にリセット（開発環境のみ）
-- reset_database.sql を実行

-- 2. マスタースキーマを再作成
-- master_schema.sql を実行

-- 3. トランザクション関数を再作成
-- create_order_transaction.sql を実行
```

## ⚠️ 注意事項

- **本番環境では `reset_database.sql` を実行しないでください**
- **`01_truncate_data.sql` を実行する前に必ずバックアップを取ってください**
- SQLスクリプトは Supabase の「SQL Editor」で実行してください

## 🔗 関連ドキュメント

詳細なセットアップ手順は [`../SPECIFICATION.md`](../SPECIFICATION.md) を参照してください。

